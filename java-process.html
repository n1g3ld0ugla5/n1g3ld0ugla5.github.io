<!DOCTYPE html>
<html>
<head>
<title>Falco Rules Library</title>
<link rel="shortcut icon" href="https://cncf-branding.netlify.app/img/projects/falco/icon/color/falco-icon-color.png">   
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
$(document).ready(function(){
  $("#show1").click(function(){
    $("#myDIV").show();
    $("#myDIV2").hide();
    $("#myDIV3").hide();
    $("#myDIV5").hide();
    $("k8s_audit_stages").hide();
    $("#myDIV4").hide(); 
    $("service_with_external_IP").hide(); 
        $("#myDIV6").hide(); 
        $("#myDIV7").hide();
        $("#myDIV8").hide();  
  });
  $("#show2").click(function(){
    $("#myDIV2").show();
    $("#myDIV").hide();
    $("#myDIV5").hide();
    $("#myDIV3").hide();
    $("k8s_audit_stages").hide(); 
    $("#myDIV4").hide(); 
    $("service_with_external_IP").hide();
        $("#myDIV6").hide();
        $("#myDIV7").hide();
        $("#myDIV8").hide();          
  });

  $("#show3").click(function(){
    $("#myDIV3").show();
    $("#myDIV2").hide();
    $("#myDIV5").hide();
    $("#myDIV").hide();
    $("k8s_audit_stages").hide(); 
    $("#myDIV4").hide(); 
    $("service_with_external_IP").hide();
    $("#myDIV6").hide(); 
    $("#myDIV7").hide();
    $("#myDIV8").hide();            
  });

    $("#show5").click(function(){
    $("#myDIV").hide();
    $("#myDIV2").hide();
    $("#myDIV3").hide();
    $("#myDIV4").hide();    
    $("#myDIV5").show();
    $("#myDIV6").hide(); 
    $("#myDIV7").hide();
    $("#myDIV8").hide();              
  });

    $("#show4").click(function(){
    $("#myDIV").hide();
    $("#myDIV2").hide();
    $("#myDIV3").hide();
    $("#myDIV4").show();    
    $("#myDIV5").hide();
    $("#myDIV6").hide(); 
    $("#myDIV7").hide();
    $("#myDIV8").hide();              
  });

      $("#show6").click(function(){
    $("#myDIV").hide();
    $("#myDIV2").hide();
    $("#myDIV3").hide();
    $("#myDIV4").hide();    
    $("#myDIV5").hide();
    $("#myDIV6").show(); 
    $("#myDIV7").hide();
    $("#myDIV8").hide();              
  });

      $("#show7").click(function(){
    $("#myDIV").hide();
    $("#myDIV2").hide();
    $("#myDIV3").hide();
    $("#myDIV4").hide();    
    $("#myDIV5").hide();
    $("#myDIV6").hide();  
    $("#myDIV7").show();
    $("#myDIV8").hide();             
  }); 

      $("#show8").click(function(){
    $("#myDIV").hide();
    $("#myDIV2").hide();
    $("#myDIV3").hide();
    $("#myDIV4").hide();    
    $("#myDIV5").hide();
    $("#myDIV6").hide();  
    $("#myDIV8").show();
    $("#myDIV7").hide();             
  });      

    $("#k8s_audit_stages").click(function(){
    $("#myDIV").hide();
    $("#myDIV2").hide();
    $("#myDIV3").hide();
    $("#myDIV4").show();    
    $("#myDIV5").hide(); 
    $("#myDIV6").hide(); 
    $("#myDIV7").hide();
    $("#myDIV8").hide();     
  });


});
</script>

<link rel="stylesheet" href="stylesheet.css">

</head>
<body>

<!--<div class="icon-bar">
  <a class="active" href="#"><i class="fa fa-home"></i></a> 
  <a href="#"><i class="fa fa-search"></i></a> 
  <a href="#"><i class="fa fa-envelope"></i></a> 
  <a href="#"><i class="fa fa-globe"></i></a>
  <a href="#"><i class="fa fa-trash"></i></a> 
</div>-->

<!-- Toolbar -->
<div class="icon-bar">
  <a class="active" href="index.html"><i class="fa fa-home"></i></a> 
  <h1>Java Process Class File Download</h1>
</div>

<br/>
<br/>

<!--<div style="text-align: left;"><a href="index.html"><img src="https://cncf-branding.netlify.app/img/projects/falco/icon/color/falco-icon-color.png" width="50" alt="My Image" /></a></div>
<center><h2>Detect outbound connections to common miner pool ports</h2></center>-->

<div id="parentDiv">

<div id="div1">
    <p id="category">Rules:</p>

<div id="clipboard">
<pre>
  <code>
- <b>rule:</b> Java Process Class File Download
  <br/><br/>
  &nbsp;&nbsp;<b>desc:</b> Detected Java process downloading a class file which could indicate a successful 
  &nbsp;&nbsp;&nbsp;exploit of the log4shell Log4j vulnerability (CVE-2021-44228)
  <br/><br/>
  &nbsp;&nbsp;<b>condition:</b> > <br/>
  &nbsp;&nbsp;&nbsp;<a id="show1">java_network_read <a id="bool">and</a> evt.buffer <a id="bool">bcontains</a> cafebabe</a>  
  <br/><br/>
  &nbsp;&nbsp;<b>output:</b> > <br/>
  &nbsp;&nbsp;&nbsp;Java process class file download (user=%user.name user_loginname=%user.loginname 
  &nbsp;&nbsp;&nbsp;user_loginuid=%user.loginuid event=%evt.type connection=%fd.name server_ip=%fd.sip 
  &nbsp;&nbsp;&nbsp;server_port=%fd.sport proto=%fd.l4proto process=%proc.name command=%proc.cmdline 
  &nbsp;&nbsp;&nbsp;pid=%proc.pid parent=%proc.pname buffer=%evt.buffer container_id=%container.id 
  &nbsp;&nbsp;&nbsp;image=%container.image.repository) 
  <br/><br/>
  &nbsp;&nbsp;<b>priority:</b> CRITICAL
  <br/><br/>
  &nbsp;&nbsp;<b>tags:</b> [mitre_initial_access]
  </code>
</pre>
</div>

<!-- Button to copy source code -->
<center><div class="tooltip">
<button onclick="copyToClip(document.getElementById('clipboard').innerHTML)" onmouseout="outFunc()">Copy Rule
<span class="tooltiptext" id="myTooltip">Copy to clipboard</span>
</button>
</div></center>

</div>



<!-- First Macro -->
<div id="myDIV">
    <p id="category">Macro:</p>
<pre>
  <code>
- <b>macro:</b> java_network_read
  <br/><br/>
  &nbsp;&nbsp;<b>condition:</b> > (evt.type=recvfrom <a id="bool">and</a> fd.type <a id="bool">in</a> (ipv4, ipv6) <a id="bool">and</a> proc.name=java)
  </code>
</pre>
</div>

<!-- Second Macro -->
<div id="myDIV2">
    <p id="category">Macro:</p>
<pre>
  <code>
- <b>macro:</b> network_local_subnet
  <br/><br/>
  &nbsp;&nbsp;<b>condition:</b> > <br/>
  &nbsp;&nbsp;&nbsp;fd.rnet <a id="bool">in</a> (<a id="show3">rfc_1918_addresses</a>) <br/>
  &nbsp;&nbsp;&nbsp;fd.ip = "0.0.0.0" or
  &nbsp;&nbsp;&nbsp;fd.net = "127.0.0.0/8"
  </code>
</pre>
</div>

<!-- Third Macro -->
<div id="myDIV3">
    <p id="category">List:</p>
<pre>
  <code>
- <b>list:</b> rfc_1918_addresses
  <br/><br/>
  &nbsp;&nbsp;<b>items:</b> ['"10.0.0.0/8"', '"172.16.0.0/12"', '"192.168.0.0/16"']
  </code>
</pre>
</div>

<!-- K8s Audit Macro -->
<div id="myDIV4">
    <p id="category">List:</p>
<pre>
  <code>
- <b>list:</b> namespace_scope_network_only_subnet
  <br/><br/>
  &nbsp;&nbsp;<b>items:</b> []
  </code>
</pre>
</div>

<!-- Miner Ports Macro -->
<div id="myDIV5">
    <p id="category">Macro:</p>
<pre>
  <code>
- <b>macro:</b> exe_running_docker_save
  <br/><br/>
  &nbsp;&nbsp;<b>condition:</b> > <br/>
  &nbsp;&nbsp;&nbsp;proc.name = "exe" <br/>
  &nbsp;&nbsp;&nbsp;<a id="bool">and</a> (proc.cmdline <a id="bool">contains</a> "/var/lib/docker" <br/>
  &nbsp;&nbsp;&nbsp;<a id="bool">or</a> proc.cmdline <a id="bool">contains</a> "/var/run/docker") <br/>
  &nbsp;&nbsp;&nbsp;<a id="bool">and</a> proc.pname <a id="bool">in</a> (dockerd, docker, dockerd-current, docker-current)  
  </code>
</pre>
</div>

<!-- Miner Domains Macro -->
<div id="myDIV6">
    <p id="category">Macro:</p>
<pre>
  <code>
- <b>macro:</b> exe_running_docker_save
<br/><br/>
 &nbsp;&nbsp;<b>condition:</b> > <br/>
  &nbsp;&nbsp;&nbsp;proc.name = "exe"<br/>
  &nbsp;&nbsp;&nbsp;<a id="bool">and</a> (proc.cmdline <a id="bool">contains</a> "/var/lib/docker"<br/>
  &nbsp;&nbsp;&nbsp;"eth-cn.dwarfpool.com","eth-cn2.dwarfpool.com","eth-eu.dwarfpool.com"<br/>
  &nbsp;&nbsp;&nbsp;<a id="bool">or</a> proc.cmdline <a id="bool">contains</a> "/var/run/docker")<br/>
  &nbsp;&nbsp;&nbsp;<a id="bool">an</a> proc.pname <a id="bool">in</a> (dockerd, docker, dockerd-current, docker-current)<br/>
  </code>
</pre>
</div>

<!-- Div7 -->
<div id="myDIV7">
    <p id="category">Macro:</p>
<pre>
  <code>
- <b>macro:</b> user_known_shell_config_modifiers
<br/><br/>
 &nbsp;&nbsp;<b>condition:</b> (<a id="show8">never_true</a>)
  </code>
</pre>
</div>

<!-- Div8 -->
<div id="myDIV8">
    <p id="category">Macro:</p>
<pre>
  <code>
- <b>macro:</b> never_true
<br/><br/>
 &nbsp;&nbsp;<b>condition:</b> (evt.num=0)
  </code>
</pre>
</div>


</div>
</div>

<div id="details">
<b><p class="small">Rule for detecting potential Log4Shell (CVE-2021-44228) exploitation</p></b>
<p class="small">Note: Not compatible with <a id="bool2">Java 17+</a>, which uses <a id="bool2">read()</a> syscalls by default<br/></p>
<hr>
<b><p class="small">Description</p></b>
<p class="small">A critical vulnerability was discovered in log4j, a widely-used open-source utility used to generate logs inside java applications. The vulnerability CVE-2021-44228, also known as Log4Shell, permits a Remote Code Execution (RCE), allowing the attackers to execute arbitrary code on the host. </p>
<hr>
<b><p class="small">Known Threat</p></b>
<p class="small">The log4j utility is popular and is used by a huge number of applications and companies, including the famous game Minecraft. It is also used in various Apache frameworks like Struts2, Kafka, Druid, Flink, and many commercial products. To learn more about Exploiting, Mitigating, and Detecting CVE-2021-44228, check out the Sysdig Secure blog <br/>
<a href="https://sysdig.com/blog/exploit-detect-mitigate-log4j-cve/"> Link to Blog </a>
<br/>
<br/>
</div>  

<script>
function copyToClip(str) {
  function listener(e) {
    e.clipboardData.setData("text/html", str);
    e.clipboardData.setData("text/plain", str);
    e.preventDefault();
  }
  document.addEventListener("copy", listener);
  document.execCommand("copy");
  document.removeEventListener("copy", listener);
};

var tooltip = document.getElementById("myTooltip");
tooltip.innerHTML = "Copied: " + copyText.value;

function outFunc() {
  var tooltip = document.getElementById("myTooltip");
  tooltip.innerHTML = "Copy to clipboard";
}
</script>

</body>
</html>